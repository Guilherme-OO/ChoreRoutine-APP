<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2d8fa3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChoreRoutine">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%232d8fa3' width='192' height='192'/%3E%3Ctext x='96' y='110' font-size='80' fill='white' text-anchor='middle' font-family='system-ui'%3E‚≠ê%3C/text%3E%3C/svg%3E">
    <title>ChoreRoutine - Rotinas & Pontos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2d8fa3; --primary-light: #41b3c9; --primary-dark: #1f6276;
            --success: #27ae60; --danger: #e74c3c; --warning: #f39c12;
            --background: #f5f5f5; --surface: #ffffff; --text: #333; --text-light: #666;
            --border: #ddd; --radius: 12px; --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background); color: var(--text); line-height: 1.6;
            padding-bottom: 100px; overflow-x: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white; padding: 20px; padding-top: max(20px, calc(env(safe-area-inset-top) + 10px));
            text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 90;
        }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 12px; opacity: 0.9; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .page { display: none; animation: fadeIn 0.3s ease-in; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--surface); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .card-header { font-weight: 600; margin-bottom: 12px; color: var(--primary); }
        .btn {
            padding: 12px 20px; border: none; border-radius: var(--radius); font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex;
            align-items: center; gap: 8px; text-decoration: none;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(45, 143, 163, 0.3); }
        .btn-secondary { background: #f0f0f0; color: var(--text); }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-full { width: 100%; justify-content: center; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); font-family: inherit; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(45, 143, 163, 0.1); }
        .child-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 16px;
            box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s ease;
        }
        .child-card:hover { transform: translateY(-4px); }
        .child-name { font-size: 20px; font-weight: 700; margin-bottom: 10px; }
        .child-points { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .child-label { font-size: 12px; opacity: 0.9; }
        .item {
            background: var(--surface); padding: 14px; border-radius: var(--radius); margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .item-content { flex: 1; }
        .item-name { font-weight: 600; margin-bottom: 4px; }
        .item-value { font-weight: 700; font-size: 16px; color: var(--primary); min-width: 50px; text-align: right; }
        .item-value.positive { color: var(--success); }
        .item-value.negative { color: var(--danger); }
        .history-item {
            background: var(--surface); padding: 12px; border-radius: var(--radius); margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .history-content { flex: 1; }
        .history-description { font-weight: 500; margin-bottom: 2px; font-size: 14px; }
        .history-date { font-size: 12px; color: var(--text-light); }
        .history-delta { font-weight: 700; font-size: 14px; padding: 6px 10px; border-radius: 8px; min-width: 60px; text-align: center; }
        .history-delta.positive { background: rgba(39, 174, 96, 0.1); color: var(--success); }
        .history-delta.negative { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .navbar {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface);
            border-top: 1px solid var(--border); display: flex; justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom); z-index: 99; box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }
        .nav-item {
            flex: 1; padding: 12px; text-align: center; cursor: pointer; border: none;
            background: none; font-size: 12px; color: var(--text-light); transition: all 0.2s ease;
            font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item:hover { background: var(--background); }
        .nav-icon { font-size: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: flex-end; }
        .modal.active { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content {
            background: var(--surface); width: 100%; border-radius: var(--radius) var(--radius) 0 0;
            padding: 24px; padding-top: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
            max-height: 80vh; overflow-y: auto;
        }
        .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--primary); }
        .modal-close { position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .sync-status { position: fixed; top: 0; left: 0; right: 0; padding: 8px; text-align: center; font-size: 12px; z-index: 89; background: var(--background); color: var(--text-light); display: none; padding-top: env(safe-area-inset-top); }
        .sync-status.active { display: block; }
        .sync-status.online { background: var(--success); color: white; }
        .sync-status.offline { background: var(--warning); color: white; }
        .tabs { display: flex; gap: 10px; margin-bottom: 16px; overflow-x: auto; }
        .tab-btn { padding: 8px 16px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; transition: all 0.2s ease; }
        .tab-btn.active { background: var(--primary); color: white; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-box { background: var(--surface); padding: 16px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-light); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="sync-status" id="syncStatus"></div>
    <div class="header">
        <h1>‚≠ê ChoreRoutine</h1>
        <p>Rotinas & Pontos</p>
    </div>
    <div class="container">
        <div class="page active" id="homePage">
            <div id="childrenContainer"></div>
            <button class="btn btn-primary btn-full" onclick="openModal('addChildModal')">‚ûï Adicionar Crian√ßa</button>
        </div>
        <div class="page" id="activitiesPage">
            <div class="card"><div class="card-header">Atividades Cadastradas</div><div id="activitiesContainer"></div></div>
            <button class="btn btn-primary btn-full" onclick="openModal('addActivityModal')">‚ûï Adicionar Atividade</button>
        </div>
        <div class="page" id="rewardsPage">
            <div class="card"><div class="card-header">Recompensas Dispon√≠veis</div><div id="rewardsContainer"></div></div>
            <button class="btn btn-primary btn-full" onclick="openModal('addRewardModal')">‚ûï Adicionar Recompensa</button>
        </div>
        <div class="page" id="goalsPage">
            <div class="card"><div class="card-header">Metas</div><div id="goalsContainer"></div></div>
            <button class="btn btn-primary btn-full" onclick="openModal('addGoalModal')">‚ûï Adicionar Meta</button>
        </div>
        <div class="page" id="reportPage">
            <div class="card"><div class="card-header">Selecione uma Crian√ßa</div><div id="reportChildrenContainer"></div></div>
            <div id="reportContainer" style="display: none;">
                <div class="tabs" id="reportTabs">
                    <button class="tab-btn active" onclick="setReportPeriod('week')">Semana</button>
                    <button class="tab-btn" onclick="setReportPeriod('month')">M√™s</button>
                    <button class="tab-btn" onclick="setReportPeriod('all')">Tudo</button>
                </div>
                <div class="stats">
                    <div class="stat-box"><div class="stat-value" id="totalPoints">0</div><div class="stat-label">Total de Pontos</div></div>
                    <div class="stat-box"><div class="stat-value" id="activitiesCount">0</div><div class="stat-label">Atividades</div></div>
                </div>
                <div class="card"><div class="card-header">Hist√≥rico</div><div id="reportHistoryContainer"></div></div>
            </div>
        </div>
    </div>
    <div class="modal" id="addChildModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addChildModal')">‚úï</button>
            <div class="modal-header">Adicionar Crian√ßa</div>
            <form onsubmit="addChild(event)">
                <div class="form-group"><label>Nome</label><input type="text" id="childName" required></div>
                <button type="submit" class="btn btn-primary btn-full">Salvar</button>
            </form>
        </div>
    </div>
    <div class="modal" id="addActivityModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addActivityModal')">‚úï</button>
            <div class="modal-header">Adicionar Atividade</div>
            <form onsubmit="addActivity(event)">
                <div class="form-group"><label>Nome da Atividade</label><input type="text" id="activityName" required></div>
                <div class="form-group"><label>Pontos</label><input type="number" id="activityPoints" required></div>
                <button type="submit" class="btn btn-primary btn-full">Salvar</button>
            </form>
        </div>
    </div>
    <div class="modal" id="addRewardModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addRewardModal')">‚úï</button>
            <div class="modal-header">Adicionar Recompensa</div>
            <form onsubmit="addReward(event)">
                <div class="form-group"><label>Nome da Recompensa</label><input type="text" id="rewardName" required></div>
                <div class="form-group"><label>Custo (Pontos)</label><input type="number" id="rewardCost" required></div>
                <button type="submit" class="btn btn-primary btn-full">Salvar</button>
            </form>
        </div>
    </div>
    <div class="modal" id="addGoalModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addGoalModal')">‚úï</button>
            <div class="modal-header">Adicionar Meta</div>
            <form onsubmit="addGoal(event)">
                <div class="form-group"><label>Selecione uma Crian√ßa</label><select id="goalChildId" required><option value="">-- Escolha --</option></select></div>
                <div class="form-group"><label>Descri√ß√£o da Meta</label><input type="text" id="goalDescription" required></div>
                <div class="form-group"><label>Pontos Necess√°rios</label><input type="number" id="goalTargetPoints" required></div>
                <button type="submit" class="btn btn-primary btn-full">Salvar</button>
            </form>
        </div>
    </div>
    <div class="modal" id="applyActivityModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('applyActivityModal')">‚úï</button>
            <div class="modal-header">Aplicar Atividade</div>
            <div id="applyActivityForm"></div>
        </div>
    </div>
    <div class="modal" id="applyRewardModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('applyRewardModal')">‚úï</button>
            <div class="modal-header">Resgatar Recompensa</div>
            <div id="applyRewardForm"></div>
        </div>
    </div>
    <div class="modal" id="childHistoryModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('childHistoryModal')">‚úï</button>
            <div class="modal-header" id="historyModalTitle">Hist√≥rico</div>
            <div id="historyContainer"></div>
        </div>
    </div>
    <div class="navbar">
        <button class="nav-item active" onclick="switchPage('homePage')"><span class="nav-icon">üè†</span><span>Home</span></button>
        <button class="nav-item" onclick="switchPage('activitiesPage')"><span class="nav-icon">üìã</span><span>Atividades</span></button>
        <button class="nav-item" onclick="switchPage('rewardsPage')"><span class="nav-icon">üéÅ</span><span>Recompensas</span></button>
        <button class="nav-item" onclick="switchPage('goalsPage')"><span class="nav-icon">üéØ</span><span>Metas</span></button>
        <button class="nav-item" onclick="switchPage('reportPage')"><span class="nav-icon">üìä</span><span>Relat√≥rio</span></button>
    </div>
    <script>
        const SUPABASE_URL = 'https://nwndhufwuhksggphxdao.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_H_F_v9oX8Hs2xiHEIinwrw_NUOe0eLN';
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function supabaseRequest(table, method = 'GET', data = null) {
            const url = `${SUPABASE_URL}/rest/v1/${table}`;
            const options = {
                method: method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                }
            };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(url, options);
            if (!response.ok) throw new Error('Erro na requisi√ß√£o');
            return await response.json();
        }
        
        let state = {
            children: [], activities: [], rewards: [], history: [], goals: [],
            selectedChildId: null, reportPeriod: 'month', isOnline: navigator.onLine, isSyncing: false
        };
        
        window.addEventListener('load', async () => {
            await initializeApp();
        });
        
        async function initializeApp() {
            await loadAllData();
            renderHome();
            setupPolling();
        }
        
        async function loadAllData() {
            try {
                setSyncing(true);
                state.children = await supabaseRequest('children') || [];
                state.activities = await supabaseRequest('activities') || [];
                state.rewards = await supabaseRequest('rewards') || [];
                state.goals = await supabaseRequest('goals') || [];
                state.history = await supabaseRequest('points_history') || [];
                state.children.forEach(child => {
                    child.points = calculateChildPoints(child.id);
                });
                populateGoalChildSelect();
                setSyncing(false);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                setSyncing(false);
            }
        }
        
        function calculateChildPoints(childId) {
            return (state.history.filter(h => h.child_id === childId && !h.reversed) || []).reduce((sum, h) => sum + (h.delta || 0), 0);
        }
        
        function setupPolling() {
            setInterval(async () => {
                if (!state.isSyncing && state.isOnline) {
                    await loadAllData();
                }
            }, 3000);
        }
        
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            if (pageId === 'reportPage') renderReportChildren();
        }
        
        function renderHome() {
            const container = document.getElementById('childrenContainer');
            if (state.children.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë∂</div>Nenhuma crian√ßa cadastrada</div>';
                return;
            }
            container.innerHTML = state.children.map(child => `
                <div class="child-card" onclick="selectChild('${child.id}')">
                    <div class="child-name">${child.name}</div>
                    <div class="child-points">${child.points || 0}</div>
                    <div class="child-label">Pontos</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                    <button class="btn btn-secondary btn-full" onclick="openApplyActivityModal('${child.id}')">‚úÖ Atividade</button>
                    <button class="btn btn-secondary btn-full" onclick="openApplyRewardModal('${child.id}')">üéÅ Recompensa</button>
                </div>
                <button class="btn btn-secondary btn-full" onclick="openChildHistory('${child.id}', '${child.name}')">üìú Hist√≥rico</button>
            `).join('');
        }
        
        function selectChild(childId) { state.selectedChildId = childId; }
        
        function renderActivities() {
            const container = document.getElementById('activitiesContainer');
            if (state.activities.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div>Nenhuma atividade cadastrada</div>';
                return;
            }
            container.innerHTML = state.activities.map(activity => `
                <div class="item">
                    <div class="item-content"><div class="item-name">${activity.name}</div></div>
                    <div class="item-value ${activity.points > 0 ? 'positive' : 'negative'}">${activity.points > 0 ? '+' : ''}${activity.points}</div>
                </div>
            `).join('');
        }
        
        async function addActivity(event) {
            event.preventDefault();
            try {
                setSyncing(true);
                await supabaseRequest('activities', 'POST', {
                    name: document.getElementById('activityName').value,
                    points: parseInt(document.getElementById('activityPoints').value)
                });
                document.getElementById('activityName').value = '';
                document.getElementById('activityPoints').value = '';
                closeModal('addActivityModal');
                await loadAllData();
                renderActivities();
                setSyncing(false);
            } catch (error) {
                console.error('Erro:', error);
                setSyncing(false);
            }
        }
        
        function renderRewards() {
            const container = document.getElementById('rewardsContainer');
            if (state.rewards.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéÅ</div>Nenhuma recompensa cadastrada</div>';
                return;
            }
            container.innerHTML = state.rewards.map(reward => `
                <div class="item">
                    <div class="item-content"><div class="item-name">${reward.name}</div></div>
                    <div class="item-value">${reward.cost} üí∞</div>
                </div>
            `).join('');
        }
        
        async function addReward(event) {
            event.preventDefault();
            try {
                setSyncing(true);
                await supabaseRequest('rewards', 'POST', {
                    name: document.getElementById('rewardName').value,
                    cost: parseInt(document.getElementById('rewardCost').value)
                });
                document.getElementById('rewardName').value = '';
                document.getElementById('rewardCost').value = '';
                closeModal('addRewardModal');
                await loadAllData();
                renderRewards();
                setSyncing(false);
            } catch (error) {
                console.error('Erro:', error);
                setSyncing(false);
            }
        }
        
        function renderGoals() {
            const container = document.getElementById('goalsContainer');
            if (state.goals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div>Nenhuma meta cadastrada</div>';
                return;
            }
            container.innerHTML = state.goals.map(goal => {
                const child = state.children.find(c => c.id === goal.child_id);
                const progress = child ? Math.min(100, (child.points / goal.target_points) * 100) : 0;
                return `
                    <div class="card">
                        <div style="margin-bottom: 10px;"><strong>${child?.name}</strong> - ${goal.description}</div>
                        <div style="margin-bottom: 8px; font-size: 12px; color: #666;">${child?.points || 0} / ${goal.target_points} pontos</div>
                        <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #2d8fa3, #41b3c9); height: 100%; width: ${progress}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function addGoal(event) {
            event.preventDefault();
            try {
                setSyncing(true);
                await supabaseRequest('goals', 'POST', {
                    child_id: document.getElementById('goalChildId').value,
                    description: document.getElementById('goalDescription').value,
                    target_points: parseInt(document.getElementById('goalTargetPoints').value),
                    achieved: false
                });
                document.getElementById('goalDescription').value = '';
                document.getElementById('goalTargetPoints').value = '';
                document.getElementById('goalChildId').value = '';
                closeModal('addGoalModal');
                await loadAllData();
                renderGoals();
                setSyncing(false);
            } catch (error) {
                console.error('Erro:', error);
                setSyncing(false);
            }
        }
        
        function populateGoalChildSelect() {
            const select = document.getElementById('goalChildId');
            select.innerHTML = '<option value="">-- Escolha uma crian√ßa --</option>' + state.children.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        function openApplyActivityModal(childId) {
            state.selectedChildId = childId;
            const child = state.children.find(c => c.id === childId);
            document.getElementById('applyActivityForm').innerHTML = `
                <div class="card"><strong>${child.name}</strong> - Pontos atuais: <strong>${child.points || 0}</strong></div>
                <div id="activitiesForApply">${state.activities.map(activity => `
                    <button class="btn btn-secondary btn-full" onclick="applyActivity('${childId}', ${activity.points}, '${activity.name}')">
                        ${activity.name} <strong>${activity.points > 0 ? '+' : ''}${activity.points}</strong>
                    </button>
                `).join('')}</div>
            `;
            openModal('applyActivityModal');
        }
        
        async function applyActivity(childId, points, activityName) {
            const today = new Date().toISOString().split('T')[0];
            try {
                await supabaseRequest('points_history', 'POST', {
                    child_id: childId, type: 'activity', delta: points, date: today, description: activityName
                });
                closeModal('applyActivityModal');
                await loadAllData();
                renderHome();
            } catch (error) {
                console.error('Erro:', error);
            }
        }
        
        function openApplyRewardModal(childId) {
            state.selectedChildId = childId;
            const child = state.children.find(c => c.id === childId);
            document.getElementById('applyRewardForm').innerHTML = `
                <div class="card"><strong>${child.name}</strong> - Pontos atuais: <strong>${child.points || 0}</strong></div>
                <div id="rewardsForApply">${state.rewards.map(reward => {
                    const hasEnough = (child.points || 0) >= reward.cost;
                    return `
                        <button class="btn ${hasEnough ? 'btn-primary' : 'btn-secondary'} btn-full" onclick="applyReward('${childId}', ${reward.cost}, '${reward.name}')" ${!hasEnough ? 'disabled' : ''}>
                            ${reward.name} - ${reward.cost} üí∞ ${!hasEnough ? '‚ùå' : ''}
                        </button>
                    `;
                }).join('')}</div>
            `;
            openModal('applyRewardModal');
        }
        
        async function applyReward(childId, cost, rewardName) {
            const today = new Date().toISOString().split('T')[0];
            try {
                await supabaseRequest('points_history', 'POST', {
                    child_id: childId, type: 'reward', delta: -cost, date: today, description: rewardName
                });
                closeModal('applyRewardModal');
                await loadAllData();
                renderHome();
            } catch (error) {
                console.error('Erro:', error);
            }
        }
        
        function openChildHistory(childId, childName) {
            const historyItems = state.history.filter(h => h.child_id === childId && !h.reversed);
            const container = document.getElementById('historyContainer');
            document.getElementById('historyModalTitle').textContent = `Hist√≥rico - ${childName}`;
            if (historyItems.length === 0) {
                container.innerHTML = '<div class="empty-state">Sem hist√≥rico</div>';
            } else {
                container.innerHTML = historyItems.map(item => `
                    <div class="history-item">
                        <div class="history-content">
                            <div class="history-description">${item.description}</div>
                            <div class="history-date">${new Date(item.date).toLocaleDateString('pt-BR')}</div>
                        </div>
                        <div class="history-delta ${item.delta > 0 ? 'positive' : 'negative'}">${item.delta > 0 ? '+' : ''}${item.delta}</div>
                    </div>
                `).join('');
            }
            openModal('childHistoryModal');
        }
        
        function renderReportChildren() {
            const container = document.getElementById('reportChildrenContainer');
            container.innerHTML = state.children.map(child => `
                <button class="btn btn-primary btn-full" onclick="selectReportChild('${child.id}')">
                    ${child.name} - ${child.points || 0} pontos
                </button>
            `).join('');
        }
        
        function selectReportChild(childId) {
            state.selectedChildId = childId;
            renderReport();
            document.getElementById('reportChildrenContainer').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'block';
        }
        
        function setReportPeriod(period) {
            state.reportPeriod = period;
            document.querySelectorAll('#reportTabs .tab-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', (idx === 0 && period === 'week') || (idx === 1 && period === 'month') || (idx === 2 && period === 'all'));
            });
            renderReport();
        }
        
        function renderReport() {
            const child = state.children.find(c => c.id === state.selectedChildId);
            if (!child) return;
            let filteredHistory = state.history.filter(h => h.child_id === state.selectedChildId && !h.reversed);
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            if (state.reportPeriod === 'week') filteredHistory = filteredHistory.filter(h => new Date(h.date) >= startOfWeek);
            else if (state.reportPeriod === 'month') filteredHistory = filteredHistory.filter(h => new Date(h.date) >= startOfMonth);
            const totalPoints = filteredHistory.reduce((sum, h) => sum + h.delta, 0);
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('activitiesCount').textContent = filteredHistory.length;
            const historyContainer = document.getElementById('reportHistoryContainer');
            if (filteredHistory.length === 0) {
                historyContainer.innerHTML = '<div class="empty-state">Sem dados neste per√≠odo</div>';
            } else {
                historyContainer.innerHTML = filteredHistory.map(item => `
                    <div class="history-item">
                        <div class="history-content">
                            <div class="history-description">${item.description}</div>
                            <div class="history-date">${new Date(item.date).toLocaleDateString('pt-BR')}</div>
                        </div>
                        <div class="history-delta ${item.delta > 0 ? 'positive' : 'negative'}">${item.delta > 0 ? '+' : ''}${item.delta}</div>
                    </div>
                `).join('');
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        async function addChild(event) {
            event.preventDefault();
            try {
                setSyncing(true);
                const childName = document.getElementById('childName').value;
                console.log('üü¢ Adicionando crian√ßa:', childName);
                await supabaseRequest('children', 'POST', { user_id: generateUUID(), name: childName });
                document.getElementById('childName').value = '';
                closeModal('addChildModal');
                await loadAllData();
                renderHome();
                setSyncing(false);
            } catch (error) {
                console.error('‚ùå Erro:', error);
                setSyncing(false);
            }
        }
        
        function setSyncing(value) {
            state.isSyncing = value;
            const status = document.getElementById('syncStatus');
            if (state.isSyncing) {
                status.textContent = 'üîÑ Sincronizando...';
                status.classList.add('active');
            } else {
                status.classList.remove('active');
            }
        }
        
        window.addEventListener('online', async () => {
            state.isOnline = true;
            await loadAllData();
        });
        
        window.addEventListener('offline', () => {
            state.isOnline = false;
        });
    </script>
</body>
</html>